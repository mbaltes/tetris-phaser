<!doctype html> 
<html lang="en"> 
<head>
    <link href="https://fonts.googleapis.com/css?family=Electrolize&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <title>Tetris</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin-left: 50px;
            background-color: grey;
            font-family: 'Electrolize', sans-serif;
        }
    </style>
</head>
<body>

<script type="text/javascript">

let config = {
    type: Phaser.AUTO,
    width: 900,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: true
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
    audio: {
        disableWebAudio: true,
    }
};

let o;
let timedEvent;
let tetriminoSpeed;
let cursors;
let walls;
let game = new Phaser.Game(config);

function preload() {
    // Load assets
    this.load.image('background', 'assets/test-background.png');
    this.load.image('separator', 'assets/bar-separator.png');
    this.load.image('o_piece', 'assets/o_piece.png');
}

function create() {
    // Background image
    this.add.image(450, 300, 'background');

    // Create vertical walls with collision detection
    walls = this.physics.add.staticGroup();
    walls.create(300, 300, 'separator');
    walls.create(600, 300, 'separator');


    // Tetriminos
    o = this.physics.add.image(450, 300, 'o_piece');
    o.setCollideWorldBounds(true);
    o.setImmovable(true);

    // Keyboard inputs
    cursors = this.input.keyboard.createCursorKeys();

    // Dropping piece using timedEvents
    timedEvent = this.time.addEvent({
        delay: 1000,
        callback: dropTetrimino,
        args: [o],
        callbackScope: this,
        loop: true
    });

    // Debug information
    tetriminoSpeed = this.add.text(100, 100, 'tVelY', {
        fontSize: '22px',
        fill: '#ffffff'
    });

    // Collision detection
    //this.physics.add.collider(o, walls);
    this.physics.add.overlap(o, walls, wallOverlap, null, this);
}

function update() {
    // Display debug text
    tetriminoSpeed.setText('Y velocity: ' + o.body.velocity.y);

    // Control tetrimino movement
    if (cursors.left.isDown) {
        o.x -= 5;
    } else if (cursors.right.isDown) {
        o.x += 5;
    }
}

function dropTetrimino(piece) {
    piece.y += 30;
}

function wallOverlap(o, walls) {
    if (o.body.position.x <= 300) {
        o.body.position.x = 300;
    } else {
        o.body.position.x = 540;
    }
}

</script>

</body>
</html>